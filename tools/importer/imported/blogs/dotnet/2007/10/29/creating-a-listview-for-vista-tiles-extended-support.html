<P>Have you ever wondered why Windows Vista's ListViews and .Net 2.0's ListViews just don't match?&nbsp; Well, after a lot of hunting on the web, and finding the best implementations, I have put together this little tutorial to turn this:</P>
<P><A href="http://www.renevo.com/blogs/dotnet/WindowsLiveWriter/CreatingaListViewforVistaTilesExtendedSu_A47B/ListView.NoStyle_2.jpg"><IMG id=id style="BORDER-TOP-WIDTH:0px;BORDER-LEFT-WIDTH:0px;BORDER-BOTTOM-WIDTH:0px;BORDER-RIGHT-WIDTH:0px;" height=437 alt=ListView.NoStyle src="http://www.renevo.com/blogs/dotnet/WindowsLiveWriter/CreatingaListViewforVistaTilesExtendedSu_A47B/ListView.NoStyle_thumb.jpg" width=826 border=0></A> </P>
<P>Into this:</P>
<P><A href="http://www.renevo.com/blogs/dotnet/WindowsLiveWriter/CreatingaListViewforVistaTilesExtendedSu_A47B/ListView.Style_2.jpg"><IMG id=id style="BORDER-TOP-WIDTH:0px;BORDER-LEFT-WIDTH:0px;BORDER-BOTTOM-WIDTH:0px;BORDER-RIGHT-WIDTH:0px;" height=437 alt=ListView.Style src="http://www.renevo.com/blogs/dotnet/WindowsLiveWriter/CreatingaListViewforVistaTilesExtendedSu_A47B/ListView.Style_thumb.jpg" width=826 border=0></A> </P>
<P><STRONG>Building the project</STRONG></P>
<P>Create a new Class Library Project somewhere on your hard drive, for now, lets name it <EM>"RenEvo.Articles.Controls"</EM>. As I state always, lets get rid of the Class1.vb that was created with the new project by right clicking and deleting it.</P>
<P><STRONG></STRONG></P>
<P><STRONG>Adding the needed references</STRONG></P>
<P>Next lets double click on "My Project" and bring up the Project Properties Editor. Click on the References tab, and add the following two references from the .Net tab.</P>
<P>System.Windows.Forms <BR>System.Drawing</P>
<P>At this time you can do a global import on the namespaces, but for this article I am going to be assuming you didn't.</P>
<P><STRONG>Creating our custom control</STRONG></P>
<P>Now that we have our environment setup, lets add a new Class by right clicking on the project "Add New Item", select <EM>Class</EM> from the items in the list, and name it <EM>VistaListView.vb.</EM> You should now have a blank class.</P>
<P>Lets go ahead and add some imports to the top of the class.</P>
<P>Imports System.Windows.Forms <BR>Imports System.ComponentModel <BR>Imports System.Drawing</P>
<P>We are now going to add some inheritance to the class by adding "Inherits ListView" under the class declaration.</P>
<P><STRONG></STRONG></P>
<P><STRONG>Adding a toolbox bitmap</STRONG></P>
<P>Since we don't like the look of the default gear icon in the Design Toolbox, lets implement the Icon from the Listview to show. Add the following attribute tag above the class declaration.</P>
<P>&lt;ToolboxBitmap(GetType(ListView))&gt; _ <BR>Public Class VistaListView</P>
<P>As you can see, we have hadded the "ToolboxBitmap" attribute, and used the Type constructor to select the ToolboxBitmap from the ListView object. There are a few other overloads for the ToolboxBitmap attribute, but we aren't going to cover those here.</P>
<P><STRONG>Declaring an API</STRONG></P>
<P>Next we are going to quickly declare an API to update the style on the control, the method that we are looking for is in the uxtheme.dll and is called "SetWindowTheme". Below is the declaration.</P>
<P>&lt;System.Runtime.InteropServices.DllImport("uxtheme.dll", Charset:=System.Runtime.InteropServices.CharSet.Unicode)&gt; _ <BR>Private Shared Function SetWindowTheme(ByVal Handle As IntPtr, ByVal Theme As String, ByVal SubIdList As String) As Integer <BR>End Function</P>
<P>We have made this method private, as we don't need to access it externally.&nbsp; We will call this function with the handle of the control to set, the theme to apply, and then we don't need to worry about the third argument at this time and will pass a null value.</P>
<P><STRONG>Creating a Vista Check</STRONG></P>
<P>We are going to want to detect wether we are running on Vista, or an earlier build of Windows.&nbsp; This is to check and see if we should even try to call the API, or just ignore it and let the regular styles be.&nbsp; Vista is version 6.* of windows, so we will simply return if the OS version is 6 or greater.</P>
<P>Private Function IsVistaOrLater() As Boolean <BR>&nbsp;&nbsp;&nbsp; Return (Environment.OSVersion.Version.Major &gt;= 6) <BR>End Function</P>
<P>Again, we made this function private, since we don't need to use it anywhere else, later on you may wish to implement these two functions into a Utilities or API class.</P>
<P><STRONG>Overrides</STRONG></P>
<P>We are going to want to override one very key method, the <EM>OnHandleCreated</EM> this method is called right after the class is created by the managed code. We will call the base method, check our os version, then if it is Vista or higher, we will set the theme to "explorer".&nbsp; There are several themes, but this is the one we want to achieve.</P>
<P>Protected Overrides Sub OnHandleCreated(ByVal e As System.EventArgs) <BR>&nbsp;&nbsp;&nbsp; MyBase.OnHandleCreated(e) </P>
<P>&nbsp;&nbsp;&nbsp; If IsVistaOrLater() Then <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetWindowTheme(Me.Handle, "explorer", Nothing) <BR>&nbsp;&nbsp;&nbsp; End If <BR>End Sub</P>
<P>Now we could drop this control on a form and run it right now, and everything would be great, but there is one more feature we should adopt.</P>
<P><STRONG>Tile View Support</STRONG></P>
<P>We are going to add another override real fast that will force a set on the View property, I will explain this in a moment.</P>
<P>Protected Overrides Sub OnVisibleChanged(ByVal e As System.EventArgs) <BR>&nbsp;&nbsp;&nbsp; MyBase.OnVisibleChanged(e) <BR>&nbsp;&nbsp;&nbsp; 'enforce a set of the view property <BR>&nbsp;&nbsp;&nbsp; View = View <BR>End Sub</P>
<P>Next we are going to shadow the View property, check to see if we are not running on vista, if we are setting Tile, and that we are not in design mode. Then if all of these are correct, we will set the view property to LargeIcon.&nbsp; This will do the check internally, instead of letting windows do it for you and cause a bit of an internal mess. Personally, I like knowing why things happen, and not let any assumptions go through. We are also going to extend the current description of the property and mention that Tile is not supported on Windows XP.</P>
<P>&lt;Description("Selects one of five different views that items can be shown in. (Tile is not supported in Windows XP).")&gt; _ <BR>Public Shadows Property View() As System.Windows.Forms.View <BR>&nbsp;&nbsp;&nbsp; Get <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.View <BR>&nbsp;&nbsp;&nbsp; End Get <BR>&nbsp;&nbsp;&nbsp; Set(ByVal value As System.Windows.Forms.View) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If value = Windows.Forms.View.Tile AndAlso IsVistaOrLater() = False AndAlso Me.DesignMode = False Then <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = Windows.Forms.View.LargeIcon <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.View = value <BR>&nbsp;&nbsp;&nbsp; End Set <BR>End Property</P>
<P><STRONG>An explanation of Shadows</STRONG></P>
<P>Shadows is a declaration type that overrides properties and functions by completely replacing the base properties, methods, etc...&nbsp; This is useful for properties and such that don't have and Overridable declaration.&nbsp; One such method that I like to use is to modify collection to return the newly added object on "Collection.Add".</P>
<P><STRONG>Conclusion</STRONG></P>
<P>Now that we have contructed the class, you should be able to compile it and drop the ListView on a form.&nbsp; If running on Vista you will notice that the tiles are now properly fully selected, and if running on XP you will see the items in LargeIcon view.</P>
<P><STRONG>Full Class</STRONG> - <A href="http://puzzleware.net/CodeHtmler/default.aspx" target=_blank>Code 2 Html</A></P>
<DIV style="FONT-FAMILY:courier new;"><SPAN style="COLOR:blue;">Imports</SPAN> System.Windows.Forms <BR><SPAN style="COLOR:blue;">Imports</SPAN> System.ComponentModel <BR><SPAN style="COLOR:blue;">Imports</SPAN> System.Drawing <BR><BR>&lt;ToolboxBitmap(<SPAN style="COLOR:blue;">GetType</SPAN>(ListView))&gt; _ <BR><SPAN style="COLOR:blue;">Public</SPAN>&nbsp;<SPAN style="COLOR:blue;">Class</SPAN> VistaListView <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Inherits</SPAN> ListView <BR><BR>&nbsp;&nbsp;&nbsp; &lt;System.Runtime.InteropServices.DllImport(<SPAN style="COLOR:maroon;">"uxtheme.dll"</SPAN>, Charset:=System.Runtime.InteropServices.CharSet.<SPAN style="COLOR:blue;">Unicode</SPAN>)&gt; _ <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Private</SPAN>&nbsp;<SPAN style="COLOR:blue;">Shared</SPAN>&nbsp;<SPAN style="COLOR:blue;">Function</SPAN> SetWindowTheme(<SPAN style="COLOR:blue;">ByVal</SPAN> Handle <SPAN style="COLOR:blue;">As</SPAN> IntPtr, <SPAN style="COLOR:blue;">ByVal</SPAN> Theme <SPAN style="COLOR:blue;">As</SPAN>&nbsp;<SPAN style="COLOR:blue;">String</SPAN>, <SPAN style="COLOR:blue;">ByVal</SPAN> SubIdList <SPAN style="COLOR:blue;">As</SPAN>&nbsp;<SPAN style="COLOR:blue;">String</SPAN>) <SPAN style="COLOR:blue;">As</SPAN>&nbsp;<SPAN style="COLOR:blue;">Integer</SPAN> <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Function</SPAN> <BR><BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Private</SPAN>&nbsp;<SPAN style="COLOR:blue;">Function</SPAN> IsVistaOrLater() <SPAN style="COLOR:blue;">As</SPAN>&nbsp;<SPAN style="COLOR:blue;">Boolean</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Return</SPAN> (Environment.OSVersion.Version.Major &gt;= <SPAN style="COLOR:maroon;">6</SPAN>) <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Function</SPAN> <BR><BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Protected</SPAN>&nbsp;<SPAN style="COLOR:blue;">Overrides</SPAN>&nbsp;<SPAN style="COLOR:blue;">Sub</SPAN> OnHandleCreated(<SPAN style="COLOR:blue;">ByVal</SPAN> e <SPAN style="COLOR:blue;">As</SPAN> System.EventArgs) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">MyBase</SPAN>.OnHandleCreated(e) <BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">If</SPAN> IsVistaOrLater() <SPAN style="COLOR:blue;">Then</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetWindowTheme(<SPAN style="COLOR:blue;">Me</SPAN>.Handle, <SPAN style="COLOR:maroon;">"explorer"</SPAN>, <SPAN style="COLOR:blue;">Nothing</SPAN>) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">If</SPAN> <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Sub</SPAN> <BR><BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Protected</SPAN>&nbsp;<SPAN style="COLOR:blue;">Overrides</SPAN>&nbsp;<SPAN style="COLOR:blue;">Sub</SPAN> OnVisibleChanged(<SPAN style="COLOR:blue;">ByVal</SPAN> e <SPAN style="COLOR:blue;">As</SPAN> System.EventArgs) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">MyBase</SPAN>.OnVisibleChanged(e) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:green;">'xp overrides of view</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; View = View <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Sub</SPAN> <BR><BR>&nbsp;&nbsp;&nbsp; &lt;Description(<SPAN style="COLOR:maroon;">"Selects one of five different views that items can be shown in. (Tile is not supported in Windows XP)."</SPAN>)&gt; _ <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Public</SPAN>&nbsp;<SPAN style="COLOR:blue;">Shadows</SPAN>&nbsp;<SPAN style="COLOR:blue;">Property</SPAN> View() <SPAN style="COLOR:blue;">As</SPAN> System.Windows.Forms.View <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Get</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Return</SPAN>&nbsp;<SPAN style="COLOR:blue;">MyBase</SPAN>.View <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Get</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">Set</SPAN>(<SPAN style="COLOR:blue;">ByVal</SPAN> value <SPAN style="COLOR:blue;">As</SPAN> System.Windows.Forms.View) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">If</SPAN> value = Windows.Forms.View.Tile <SPAN style="COLOR:blue;">AndAlso</SPAN> IsVistaOrLater() = <SPAN style="COLOR:maroon;">False</SPAN>&nbsp;<SPAN style="COLOR:blue;">AndAlso</SPAN>&nbsp;<SPAN style="COLOR:blue;">Me</SPAN>.DesignMode = <SPAN style="COLOR:maroon;">False</SPAN>&nbsp;<SPAN style="COLOR:blue;">Then</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = Windows.Forms.View.LargeIcon <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">If</SPAN> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">MyBase</SPAN>.View = value <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Set</SPAN> <BR>&nbsp;&nbsp;&nbsp; <SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Property</SPAN> <BR><BR><SPAN style="COLOR:blue;">End</SPAN>&nbsp;<SPAN style="COLOR:blue;">Class</SPAN> <BR></DIV><img src="http://renevo.com/aggbug.aspx?PostID=1523" width="1" height="1">