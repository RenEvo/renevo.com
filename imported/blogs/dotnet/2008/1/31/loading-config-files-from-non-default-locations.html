<P>I have spent a good deal of my time trying to figure out how to load a *.config file that is compatable with the System.Configuration.Configuration object. Over the years I have done several "fake" .config files, which where nothing more then glorified structured xml files that I manually load.&nbsp; I have also even created fake 0 byte files so I could load the .config using the OpenExeConfiguration.</P>
<P>Until recently, this has been a viable solution, and since these files where mostly hidden by ClickOnce installations and storing them in the Application Data file structure. Now though, I got a hair up my butt to do it correctly.</P>
<P>Enter the System.Configuration.ExeConfigurationFileMap class.&nbsp; This lets you specify an exe config file name, and allows you to load it up at runtime without having a valid executable to load off of.&nbsp; So now, I can save logged in specific users along with windows users configuration files.&nbsp; </P>
<P>For example, my goal was to do the following: <BR>Allow the user to setup connections and save them to the Application Data\Product\ folder under their user account. <BR>After authenticating with the server, I want to store per-logged in user settings.</P>
<P>Just short of using datasets and/or serialized objects, I was using folders to seperate between the different logged in users.</P>
<P>Now, to the solution:</P>
<DIV class=csharpcode><PRE class=alt><SPAN class=lnum>   1:  </SPAN><SPAN class=kwrd>Imports</SPAN> System.Configuration</PRE><PRE><SPAN class=lnum>   2:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>   3:  </SPAN><SPAN class=kwrd>Public</SPAN> <SPAN class=kwrd>Class</SPAN> LocalConfiguration</PRE><PRE><SPAN class=lnum>   4:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>   5:  </SPAN>    <SPAN class=kwrd>Public</SPAN> <SPAN class=kwrd>Shared</SPAN> <SPAN class=kwrd>Function</SPAN> GetConfig(<SPAN class=kwrd>ByVal</SPAN> Path <SPAN class=kwrd>As</SPAN> <SPAN class=kwrd>String</SPAN>) <SPAN class=kwrd>As</SPAN> Configuration</PRE><PRE><SPAN class=lnum>   6:  </SPAN>        <SPAN class=kwrd>Dim</SPAN> retVal <SPAN class=kwrd>As</SPAN> Configuration = <SPAN class=kwrd>Nothing</SPAN></PRE><PRE class=alt><SPAN class=lnum>   7:  </SPAN>&nbsp;</PRE><PRE><SPAN class=lnum>   8:  </SPAN>        <SPAN class=kwrd>Dim</SPAN> configFileMap <SPAN class=kwrd>As</SPAN> <SPAN class=kwrd>New</SPAN> ExeConfigurationFileMap()</PRE><PRE class=alt><SPAN class=lnum>   9:  </SPAN>        configFileMap.ExeConfigFilename = Path</PRE><PRE><SPAN class=lnum>  10:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  11:  </SPAN>        retVal = ConfigurationManager.OpenMappedExeConfiguration(configFileMap, ConfigurationUserLevel.None)</PRE><PRE><SPAN class=lnum>  12:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  13:  </SPAN>        <SPAN class=kwrd>Return</SPAN> retVal</PRE><PRE><SPAN class=lnum>  14:  </SPAN>    <SPAN class=kwrd>End</SPAN> <SPAN class=kwrd>Function</SPAN></PRE><PRE class=alt><SPAN class=lnum>  15:  </SPAN>&nbsp;</PRE><PRE><SPAN class=lnum>  16:  </SPAN><SPAN class=kwrd>End</SPAN> Class</PRE></DIV>
<P>That is it, now you can simply load a valid application config file and get a System.Configuration.Configuration object back.&nbsp; All it takes is the following line of code:</P>
<DIV class=csharpcode><PRE class=alt><SPAN class=lnum>   1:  </SPAN>        <SPAN class=kwrd>Dim</SPAN> config <SPAN class=kwrd>As</SPAN> Configuration = LocalConfiguration.GetConfig(<SPAN class=str>"./data/user.config"</SPAN>)</PRE></DIV>
<P>The beuty is, the file doesn't even have to exist. When you save the config, it will automatically create it if it doesn't exist.</P>
<P>The next step, which turned out to be a bit tricky, was actually saving stuff, like appSettings, to the file, specifically if they didn't exist to begin with.</P>
<DIV class=csharpcode>
<DIV class=csharpcode><PRE class=alt><SPAN class=lnum>   1:  </SPAN>    <SPAN class=kwrd>Private</SPAN> <SPAN class=kwrd>Sub</SPAN> LoadSettings()</PRE><PRE><SPAN class=lnum>   2:  </SPAN>        <SPAN class=kwrd>Dim</SPAN> config <SPAN class=kwrd>As</SPAN> Configuration = LocalConfiguration.GetConfig(<SPAN class=str>"./data/user.config"</SPAN>)</PRE><PRE class=alt><SPAN class=lnum>   3:  </SPAN>        <SPAN class=kwrd>Dim</SPAN> newSection <SPAN class=kwrd>As</SPAN> AppSettingsSection = <SPAN class=kwrd>Nothing</SPAN></PRE><PRE><SPAN class=lnum>   4:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>   5:  </SPAN>        <SPAN class=kwrd>If</SPAN> config.Sections(<SPAN class=str>"MySettings"</SPAN>) <SPAN class=kwrd>Is</SPAN> <SPAN class=kwrd>Nothing</SPAN> <SPAN class=kwrd>Then</SPAN></PRE><PRE><SPAN class=lnum>   6:  </SPAN>            newSection = <SPAN class=kwrd>New</SPAN> AppSettingsSection()</PRE><PRE class=alt><SPAN class=lnum>   7:  </SPAN>            newSection.SectionInformation.AllowExeDefinition = ConfigurationAllowExeDefinition.MachineToLocalUser</PRE><PRE><SPAN class=lnum>   8:  </SPAN>            config.Sections.Add(<SPAN class=str>"MySettings"</SPAN>, newSection)</PRE><PRE class=alt><SPAN class=lnum>   9:  </SPAN>        <SPAN class=kwrd>Else</SPAN></PRE><PRE><SPAN class=lnum>  10:  </SPAN>            newSection = config.Sections(<SPAN class=str>"MySettings"</SPAN>)</PRE><PRE class=alt><SPAN class=lnum>  11:  </SPAN>        <SPAN class=kwrd>End</SPAN> <SPAN class=kwrd>If</SPAN></PRE><PRE><SPAN class=lnum>  12:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  13:  </SPAN>        <SPAN class=kwrd>If</SPAN> newSection.Settings(<SPAN class=str>"Text"</SPAN>) <SPAN class=kwrd>Is</SPAN> <SPAN class=kwrd>Nothing</SPAN> <SPAN class=kwrd>Then</SPAN></PRE><PRE><SPAN class=lnum>  14:  </SPAN>            newSection.Settings.Add(<SPAN class=str>"Text"</SPAN>, <SPAN class=kwrd>Me</SPAN>.Text)</PRE><PRE class=alt><SPAN class=lnum>  15:  </SPAN>        <SPAN class=kwrd>End</SPAN> <SPAN class=kwrd>If</SPAN></PRE><PRE><SPAN class=lnum>  16:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  17:  </SPAN>        <SPAN class=kwrd>Me</SPAN>.Text = newSection.Settings(<SPAN class=str>"Text"</SPAN>).Value</PRE><PRE><SPAN class=lnum>  18:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  19:  </SPAN>        config.Save(ConfigurationSaveMode.Minimal)</PRE><PRE><SPAN class=lnum>  20:  </SPAN>&nbsp;</PRE><PRE class=alt><SPAN class=lnum>  21:  </SPAN>    <SPAN class=kwrd>End</SPAN> <SPAN class=kwrd>Sub</SPAN></PRE></DIV>
<P>On line 2 I call the method from the first example to get the configuration object, next I define an AppSettingsSection which is a key/value pair collection that is used in the &lt;appSettings&gt; in normal .config files.&nbsp; Depeding on whether the section exists or not in the current file I either set the newSection to the existing reference, or create a new one, set the SectionInformation to Allow Machine to Local User, then work with the keys as normal.</P>
<P>Finally, I save the config file, just incase it didn't exist before I read it into the application.</P>
<P>Once saved, the user.config looks like this:</P>
<DIV class=csharpcode><PRE class=alt><SPAN class=lnum>   1:  </SPAN><SPAN class=kwrd>&lt;?</SPAN><SPAN class=html>xml</SPAN> <SPAN class=attr>version</SPAN><SPAN class=kwrd>="1.0"</SPAN> <SPAN class=attr>encoding</SPAN><SPAN class=kwrd>="utf-8"</SPAN>?<SPAN class=kwrd>&gt;</SPAN></PRE><PRE><SPAN class=lnum>   2:  </SPAN><SPAN class=kwrd>&lt;</SPAN><SPAN class=html>configuration</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE><PRE class=alt><SPAN class=lnum>   3:  </SPAN>    <SPAN class=kwrd>&lt;</SPAN><SPAN class=html>configSections</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE><PRE><SPAN class=lnum>   4:  </SPAN>        <SPAN class=kwrd>&lt;</SPAN><SPAN class=html>section</SPAN> <SPAN class=attr>name</SPAN><SPAN class=kwrd>="MySettings"</SPAN> <SPAN class=attr>type</SPAN><SPAN class=kwrd>="System.Configuration.AppSettingsSection, System.Configuration, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</SPAN> <SPAN class=attr>allowExeDefinition</SPAN><SPAN class=kwrd>="MachineToLocalUser"</SPAN> <SPAN class=kwrd>/&gt;</SPAN></PRE><PRE class=alt><SPAN class=lnum>   5:  </SPAN>    <SPAN class=kwrd>&lt;/</SPAN><SPAN class=html>configSections</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE><PRE><SPAN class=lnum>   6:  </SPAN>    <SPAN class=kwrd>&lt;</SPAN><SPAN class=html>MySettings</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE><PRE class=alt><SPAN class=lnum>   7:  </SPAN>        <SPAN class=kwrd>&lt;</SPAN><SPAN class=html>add</SPAN> <SPAN class=attr>key</SPAN><SPAN class=kwrd>="Text"</SPAN> <SPAN class=attr>value</SPAN><SPAN class=kwrd>="My Application"</SPAN> <SPAN class=kwrd>/&gt;</SPAN></PRE><PRE><SPAN class=lnum>   8:  </SPAN>    <SPAN class=kwrd>&lt;/</SPAN><SPAN class=html>MySettings</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE><PRE class=alt><SPAN class=lnum>   9:  </SPAN><SPAN class=kwrd>&lt;/</SPAN><SPAN class=html>configuration</SPAN><SPAN class=kwrd>&gt;</SPAN></PRE></DIV>
<P>As you can see, it created a new config section named "MySettings" using the System.Configuration.AppSettingsSection.</P>
<P>Pretty simple once you get the hang of it, and I could very easily see a CAB based, or plugin based application really taking advantage of loading different config sections per module/plugin, and reading other settings from other modules/plugins.</P>
<P>In the next discovery, I will be trying to figure out how to merge multiple configurations into a single config file to ease the reading of multi-configs.</P></DIV><img src="http://renevo.com/aggbug.aspx?PostID=1706" width="1" height="1">